# 🤖 闭环圆形行走程序使用指南

## 📋 程序概述

`circle_walk.py` 是一个基于**陀螺仪+里程计双闭环控制**的圆形行走程序。

### 核心功能
- 使用陀螺仪追踪机器人累计转过的角度
- 使用里程计记录起始位置
- 快完成一圈时，自动引导机器人回到起点
- 支持手柄/键盘切换手动/自动模式

---

## 🚀 快速开始

### 运行程序
```bash
cd ~/下载/booster_robotics_sdk
python3 circle_walk.py
```

### 控制方式

| 控制方式 | 操作 |
|----------|------|
| 🎮 手柄 | 按住 **LT + RT + 十字键上**，松开切换模式 |
| ⌨️ 键盘 | 按 **'s'** 开始走圈，**'m'** 切换模式，**'r'** 重置，**'q'** 退出 |

---

## ⚙️ 配置参数详解

配置参数位于代码顶部的 `CONFIG` 字典中：

### 网络配置
```python
"NETWORK_INTERFACE": "127.0.0.1",  # SDK通信地址（本机）
"DOMAIN_ID": 0,                     # DDS Domain ID
```

### 圆形行走参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CIRCLE_FORWARD_SPEED` | 0.25 m/s | 前进速度 |
| `CIRCLE_TURN_SPEED` | 0.25 rad/s | 转向角速度 |
| `CIRCLE_DIRECTION` | 1 | 方向：1=左圈(逆时针)，-1=右圈(顺时针) |

**圆的大小** = 前进速度 ÷ 转向速度
- 相同速度 → 半径约 1m
- 前进速度大、转向速度小 → 大圈
- 前进速度小、转向速度大 → 小圈

### 控制参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CONTROL_HZ` | 20 | 控制频率 (Hz)，每秒发送运动指令次数 |
| `YAW_RATE_KP` | 0.3 | 角速度P增益，越大校正越激进 |

### 回原点参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `RETURN_THRESHOLD_DEG` | 300° | 转过此角度后开始回原点 |
| `POSITION_TOLERANCE` | 0.15 m | 距起点此距离内算"到达" |
| `HEADING_KP` | 1.0 | 航向控制增益 |

### 模式选择

| 参数 | 值 | 说明 |
|------|-----|------|
| `SINGLE_CIRCLE_MODE` | True | 走一圈停止 |
| `SINGLE_CIRCLE_MODE` | False | 连续走圈 |

---

## 🔧 常见配置示例

### 走更大的圈
```python
"CIRCLE_FORWARD_SPEED": 0.4,   # 提高前进速度
"CIRCLE_TURN_SPEED": 0.2,      # 降低转向速度
```

### 走更小的圈
```python
"CIRCLE_FORWARD_SPEED": 0.2,   # 降低前进速度  
"CIRCLE_TURN_SPEED": 0.4,      # 提高转向速度
```

### 走右圈（顺时针）
```python
"CIRCLE_DIRECTION": -1,
```

### 连续走圈不停止
```python
"SINGLE_CIRCLE_MODE": False,
```

### 回原点更精准
```python
"POSITION_TOLERANCE": 0.05,    # 5cm 误差
```

---

## 🔄 程序工作流程

```
┌──────────────────────────────────────────────────────┐
│                    程序启动                           │
└──────────────────────────────────────────────────────┘
                         ↓
┌──────────────────────────────────────────────────────┐
│  初始化 SDK、IMU订阅、里程计订阅、手柄订阅             │
└──────────────────────────────────────────────────────┘
                         ↓
┌──────────────────────────────────────────────────────┐
│  等待用户按 's' 开始走圈                              │
│  此时记录起始位置 (start_x, start_y)                  │
└──────────────────────────────────────────────────────┘
                         ↓
┌──────────────────────────────────────────────────────┐
│  阶段1: 走圈阶段                                     │
│  • 持续前进 + 转向                                   │
│  • 陀螺仪追踪累计角度                                 │
│  • 角速度闭环控制保持稳定转弯                          │
└──────────────────────────────────────────────────────┘
                         ↓
          累计角度 >= RETURN_THRESHOLD_DEG (300°)?
                    ↓ 是
┌──────────────────────────────────────────────────────┐
│  阶段2: 回原点阶段                                   │
│  • 计算起点方向                                      │
│  • 航向控制引导机器人朝起点走                          │
│  • 持续检查距离起点的距离                             │
└──────────────────────────────────────────────────────┘
                         ↓
          距起点 < POSITION_TOLERANCE (0.15m)?
                    ↓ 是
┌──────────────────────────────────────────────────────┐
│  到达原点！                                          │
│  SINGLE_CIRCLE_MODE=True → 停止                      │
│  SINGLE_CIRCLE_MODE=False → 继续下一圈               │
└──────────────────────────────────────────────────────┘
```

---

## 📊 状态输出说明

程序运行时会输出状态信息：

```
[走圈] 累计:180.5° | 到起点:0.85m | ωz:0.25→0.28
```

| 字段 | 说明 |
|------|------|
| 累计 | 陀螺仪追踪的累计转过角度 |
| 到起点 | 当前位置距起点的距离（米） |
| ωz | 目标角速度 → 实际发送的角速度 |

---

## ❓ 常见问题

### Q: 机器人不走圈，一直停着？
**A**: 确保按了 **'s'** 键开始走圈，程序启动后默认是等待状态。

### Q: 回原点不准？
**A**: 
1. 降低 `POSITION_TOLERANCE` 值
2. 增大 `HEADING_KP` 值
3. 确保地面平整，里程计漂移会影响精度

### Q: 走圈抖动？
**A**: 降低 `YAW_RATE_KP` 值，如改为 0.1

### Q: 圈太大/太小？
**A**: 调整 `CIRCLE_FORWARD_SPEED` 和 `CIRCLE_TURN_SPEED` 的比例

---

## 📁 相关文件

| 文件 | 说明 |
|------|------|
| `circle_walk.py` | 闭环圆形行走主程序 |
| `move.py` | 开环运动程序（无传感器反馈） |
| `sensor_monitor.py` | 传感器数据监控工具 |
